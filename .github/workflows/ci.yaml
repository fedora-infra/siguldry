name: CI
permissions:
  contents: read
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: "30 0 * * SUN"

jobs:
  audit:
    name: Cargo dependency checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        id: rust-toolchain

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1

      - name: Install cargo-deny
        run: |
          cargo install --locked cargo-deny

      - name: Check for security advisories
        run: cargo deny --log-level info --workspace check --show-stats advisories

      - name: Check for unexpected licenses from dependencies
        run: cargo deny --log-level info --workspace check --show-stats licenses

      - name: Check crates are from expected sources
        run: cargo deny --log-level info --workspace check --show-stats sources

  zizmor:
    name: GitHub Actions lints
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@557e51de59eb14aaaba2ed9621916900a91d50c6

      - name: Run zizmor ðŸŒˆ
        run: uvx zizmor .

  test:
    name: Unit tests
    runs-on: ubuntu-latest
    container:
      image: quay.io/fedora/fedora:42
    strategy:
      matrix:
        # Support current stable and the toolchain that ships with
        # the latest RHEL 9 minor release. 9.6 targets 1.84.
        #
        # https://issues.redhat.com/browse/RHEL-61964
        rust-toolchain: [stable, "1.84"]
    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        id: rust-toolchain
        with:
          toolchain: ${{matrix.rust-toolchain}}
          components: clippy, rustfmt
      - name: Install nextest
        uses: taiki-e/install-action@e7ef886cf8f69c25ecef6bbc2858a42e273496ec # 2.62.28
        with:
          tool: nextest@0.9

      - uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1

      - name: Install test packages
        run: |
          dnf install -y \
            capnproto \
            clang \
            sequoia-sq \
            sequoia-keystore-server \
            pesign \
            pkcs11-provider \
            pkg-config \
            python3-devel \
            opensc \
            openssl \
            openssl-devel \
            softhsm \
            sqlite-devel

          # pesign-client doesn't let you configure the socket location, so make it available to the world
          sudo mkdir -p /run/pesign/
          sudo chmod -R 777 /run/pesign/

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo build
        run: cargo build

      - name: cargo clippy
        run: cargo clippy --all-targets --all-features -- --deny warnings

      - name: Run unit tests
        run: cargo nextest run

      - name: Check manual is up-to-date
        run: cargo xtask manual && test -z "$(git status --porcelain)"

  legacy-integration-tests:
    name: Sigul integration tests
    runs-on: ubuntu-latest
    container: quay.io/jeremycline/sigul-pesign-bridge-ci:2025-06-02
    services:
      sigul-bridge:
        image: quay.io/jeremycline/sigul-pesign-bridge-ci:2025-06-02
        env:
          RUN_SIGUL_BRIDGE: true
        volumes:
          - ./devel/github:/etc/sigul
        options: >-
          --health-cmd "ss -o state established '( sport = :44333 )' && ss -lnt '( sport = :44334 )'"
          --health-timeout 3s
          --health-interval 5s
          --health-retries 5

      sigul-server:
        image: quay.io/jeremycline/sigul-pesign-bridge-ci:2025-06-02
        env:
          RUN_SIGUL_SERVER: true
        volumes:
          - ./devel/github:/etc/sigul
        options: >-
          --health-cmd "ss -tn -o state established '( dport = :44333 )'"
          --health-timeout 3s
          --health-interval 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Install nextest
        uses: taiki-e/install-action@e7ef886cf8f69c25ecef6bbc2858a42e273496ec # 2.62.28
        with:
          tool: nextest@0.9

      - name: Integration tests
        run: |
          set -xeuo pipefail

          # The sample UEFI application is baked into the image.
          cp -r /srv/siguldry/target .
          mkdir -p /run/pesign/
          export RUNTIME_DIRECTORY=/run/pesign
          export CREDENTIALS_DIRECTORY=/srv/siguldry/creds/
          export SIGUL_PESIGN_BRIDGE_CONFIG=$(pwd)/devel/github/config.toml
          export RUST_BACKTRACE=1
          pushd siguldry
          cargo nextest --profile sigul run --no-default-features --features "sigul-client"
          popd
          pushd sigul-pesign-bridge
          cargo nextest --profile sigul run
          popd
